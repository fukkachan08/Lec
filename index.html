<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Variance Lab（ぶれ実験）</title>
  <style>
    body { font-family: system-ui, sans-serif; max-width: 980px; margin: 24px auto; padding: 0 16px; }
    textarea { width: 100%; height: 110px; }
    input[type="number"] { width: 90px; }
    .row { display:flex; gap:12px; flex-wrap:wrap; align-items:center; margin: 12px 0; }
    .card { border: 1px solid #ddd; border-radius: 12px; padding: 12px; margin: 10px 0; }
    .muted { color:#666; font-size: 0.92em; }
    .out { white-space: pre-wrap; }
    button { padding: 10px 14px; border-radius: 10px; border: 1px solid #aaa; background: #fff; cursor: pointer; }
    button:disabled { opacity: 0.6; cursor: not-allowed; }
    code { background:#f6f6f6; padding:2px 6px; border-radius:6px; }
  </style>
</head>
<body>
  <h1>Variance Lab（生成AIのぶれを統計で見る）</h1>
  <p class="muted">同じ指示をN回サンプリングして、ぶれ（確率的予測）を数値化する。</p>

  <div class="card">
    <label>お題（プロンプト）</label>
    <textarea id="prompt">次の文章を20字で要約して：「生成AIは統計的予測であり、出力にはぶれがある。」</textarea>

    <div class="row">
      <label>N回: <input id="n" type="number" min="1" max="10" value="8"></label>
      <label>文字数上限: <input id="limit" type="number" min="5" max="200" value="20"></label>
      <label>max_output_tokens: <input id="mot" type="number" min="20" max="160" value="90"></label>
      <button id="run">実行</button>
      <span id="status" class="muted"></span>
    </div>

    <div class="muted">
      Workers側で <code>N<=10</code>, <code>max_output_tokens<=160</code> を強制してる（暴発防止）。
    </div>
  </div>

  <div class="card">
    <h2 style="margin:0 0 8px 0;">集計</h2>
    <div id="summary" class="out muted">まだ実行していません。</div>
  </div>

  <div class="card">
    <h2 style="margin:0 0 8px 0;">出力</h2>
    <div id="outputs" class="out muted">ここに結果が表示されます。</div>
  </div>

<script>
  // ★ここだけ自分のWorker URLに変更
  const WORKER_URL = "https://muddy-wave-7c5c.marbo0805.workers.dev";

  const $ = (id) => document.getElementById(id);

  function charLenJP(s) { return Array.from(s).length; }

  function calcStats(texts, limit) {
    const cleaned = texts.map(t => (t ?? "").trim());
    const set = new Set(cleaned);
    const lens = cleaned.map(t => charLenJP(t));
    const avgLen = lens.reduce((a,b)=>a+b,0) / Math.max(1, lens.length);
    const violations = lens.filter(l => l > limit).length;

    const freq = new Map();
    for (const t of cleaned) freq.set(t, (freq.get(t) ?? 0) + 1);
    let modeCount = 0, modeText = "";
    for (const [t,c] of freq.entries()) if (c > modeCount) { modeCount = c; modeText = t; }

    return {
      n: cleaned.length,
      unique: set.size,
      uniqueRate: set.size / Math.max(1, cleaned.length),
      avgLen,
      violations,
      violationRate: violations / Math.max(1, cleaned.length),
      modeCount,
      modeRate: modeCount / Math.max(1, cleaned.length),
      modeText
    };
  }

  async function sampleMany({ prompt, n, max_output_tokens }) {
    const res = await fetch(`${WORKER_URL}/sample`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ prompt, n, max_output_tokens }),
    });
    if (!res.ok) throw new Error(await res.text());
    return await res.json(); // { outputs: [...] }
  }

  function renderOutputs(list) {
    const root = $("outputs");
    root.innerHTML = "";
    list.forEach((t, i) => {
      const div = document.createElement("div");
      div.style.borderTop = "1px dashed #ddd";
      div.style.paddingTop = "8px";
      div.style.marginTop = "8px";
      div.textContent = `#${i+1}（${charLenJP(t)}字）\n${t}`;
      root.appendChild(div);
    });
  }

  $("run").addEventListener("click", async () => {
    const prompt = $("prompt").value.trim();
    const n = Math.min(10, Math.max(1, parseInt($("n").value, 10) || 1));
    const limit = Math.max(1, parseInt($("limit").value, 10) || 20);
    const mot = Math.min(160, Math.max(20, parseInt($("mot").value, 10) || 90));

    if (!prompt) { $("summary").textContent = "プロンプトが空です。"; return; }

    $("run").disabled = true;
    $("status").textContent = "実行中...";
    $("outputs").textContent = "";
    $("summary").textContent = "";

    try {
      const { outputs } = await sampleMany({ prompt, n, max_output_tokens: mot });
      renderOutputs(outputs);

      const s = calcStats(outputs, limit);
      $("summary").textContent =
        `N=${s.n}\n` +
        `ユニーク数=${s.unique}（ユニーク率=${(s.uniqueRate*100).toFixed(1)}%）\n` +
        `平均文字数=${s.avgLen.toFixed(1)}\n` +
        `文字数上限${limit}字 超過=${s.violations}（${(s.violationRate*100).toFixed(1)}%）\n` +
        `最頻出（mode）=${s.modeCount}回（mode率=${(s.modeRate*100).toFixed(1)}%）\n` +
        `mode例：「${s.modeText}」\n\n` +
        `考察：プロンプトを具体化すると、違反率やmode率はどう変わる？`;

      $("status").textContent = "完了";
    } catch (e) {
      $("status").textContent = "エラー";
      $("summary").textContent = String(e);
    } finally {
      setTimeout(() => { $("run").disabled = false; }, 800);
    }
  });
</script>
</body>
</html>
