<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Variance Lab</title>
  <style>
    body { font-family: system-ui, sans-serif; max-width: 800px; margin: 24px auto; padding: 0 16px; background: #f5f5f5; }
    .header { text-align: center; margin-bottom: 24px; }
    .header h1 { margin: 0; color: #333; font-size: 28px; }
    .header p { margin: 8px 0 0 0; color: #666; font-size: 15px; }
    .card { background: #fff; border-radius: 16px; padding: 24px; margin: 16px 0; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
    .card h2 { margin: 0 0 16px 0; font-size: 18px; color: #333; }

    /* モード選択 */
    .modes { display: flex; gap: 12px; flex-wrap: wrap; margin-bottom: 20px; }
    .mode-option { display: flex; align-items: center; gap: 6px; }
    .mode-option input[type="radio"] { width: 18px; height: 18px; cursor: pointer; }
    .mode-option label { cursor: pointer; font-size: 15px; }

    /* 指示文表示 */
    .instruction { background: #f0f7ff; border-left: 4px solid #4a90e2; padding: 12px 16px; margin: 16px 0; border-radius: 6px; color: #333; font-size: 15px; }

    /* 入力欄 */
    textarea { width: 100%; height: 80px; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 15px; font-family: inherit; resize: vertical; }
    textarea:focus { outline: none; border-color: #4a90e2; }

    /* スライドバー */
    .slider-group { margin: 16px 0; }
    .slider-label { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
    .slider-label span { font-size: 14px; color: #666; }
    .slider-label strong { font-size: 16px; color: #333; }
    input[type="range"] { width: 100%; height: 8px; border-radius: 4px; background: #ddd; outline: none; -webkit-appearance: none; }
    input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 20px; height: 20px; border-radius: 50%; background: #4a90e2; cursor: pointer; }
    input[type="range"]::-moz-range-thumb { width: 20px; height: 20px; border-radius: 50%; background: #4a90e2; cursor: pointer; border: none; }

    /* Temperature用のグラデーション */
    #temp { background: linear-gradient(to right, #4a90e2 0%, #e94b3c 100%); }

    .temp-hint { font-size: 13px; color: #666; margin-top: 4px; text-align: center; }

    /* ボタン */
    .run-btn { width: 100%; padding: 16px; font-size: 18px; font-weight: bold; border-radius: 10px; border: none; background: #4a90e2; color: white; cursor: pointer; margin-top: 20px; transition: background 0.2s; }
    .run-btn:hover { background: #3a7bc8; }
    .run-btn:disabled { opacity: 0.6; cursor: not-allowed; background: #999; }

    .status { text-align: center; margin-top: 12px; color: #666; font-size: 14px; }

    /* 結果表示 */
    .out { white-space: pre-wrap; line-height: 1.6; color: #333; }
    .muted { color: #666; font-size: 14px; }
    .output-item { border-top: 1px dashed #ddd; padding-top: 12px; margin-top: 12px; }
    .output-item:first-child { border-top: none; margin-top: 0; padding-top: 0; }
  </style>
</head>
<body>
  <div class="header">
    <h1>Variance Lab</h1>
    <p>生成AIのぶれを統計で見る</p>
  </div>

  <div class="card">
    <h2>実験設定</h2>

    <div class="modes">
      <div class="mode-option">
        <input type="radio" id="mode-summary" name="mode" value="summary" checked>
        <label for="mode-summary">要約</label>
      </div>
      <div class="mode-option">
        <input type="radio" id="mode-yesno" name="mode" value="yesno">
        <label for="mode-yesno">Yes/No判定</label>
      </div>
      <div class="mode-option">
        <input type="radio" id="mode-association" name="mode" value="association">
        <label for="mode-association">連想語</label>
      </div>
      <div class="mode-option">
        <input type="radio" id="mode-synonym" name="mode" value="synonym">
        <label for="mode-synonym">同義語生成</label>
      </div>
    </div>

    <div id="instruction" class="instruction"></div>

    <textarea id="target" placeholder=""></textarea>

    <div class="slider-group">
      <div class="slider-label">
        <span>試行回数</span>
        <strong id="n-value">5</strong>
      </div>
      <input type="range" id="n" min="1" max="10" value="5">
    </div>

    <div class="slider-group">
      <div class="slider-label">
        <span>Temperature（ぶれの大きさ）</span>
        <strong id="temp-value">1.0</strong>
      </div>
      <input type="range" id="temp" min="0" max="2" step="0.1" value="1.0">
      <div class="temp-hint">0 = 安定・一貫 ⇔ 2 = ランダム・多様</div>
    </div>

    <button id="run" class="run-btn">実験スタート</button>
    <div id="status" class="status"></div>
  </div>

  <div class="card">
    <h2>結果</h2>
    <div id="summary" class="out muted">まだ実行していません。</div>
  </div>

  <div class="card">
    <h2>各回の出力</h2>
    <div id="outputs" class="out muted">ここに結果が表示されます。</div>
  </div>

<script>
  const WORKER_URL = "https://back.marbo0805.workers.dev";

  const $ = (id) => document.getElementById(id);
  const charLenJP = (s) => Array.from(s).length;

  // モード定義
  const MODES = {
    summary: {
      instruction: "次の文章を20字で要約して",
      placeholder: "生成AIは統計的予測であり、出力にはぶれがある。",
      defaultText: "生成AIは統計的予測であり、出力にはぶれがある。",
      maxTokens: 60
    },
    yesno: {
      instruction: "次の質問にYesかNoで答えて",
      placeholder: "トマトは野菜ですか？",
      defaultText: "トマトは野菜ですか？",
      maxTokens: 10
    },
    association: {
      instruction: "○○から連想する言葉を1つ答えて",
      placeholder: "海",
      defaultText: "海",
      maxTokens: 20
    },
    synonym: {
      instruction: "○○の同義語を1つ答えて",
      placeholder: "美しい",
      defaultText: "美しい",
      maxTokens: 20
    }
  };

  // モード変更時の処理
  function updateMode() {
    const mode = document.querySelector('input[name="mode"]:checked').value;
    const config = MODES[mode];
    $("instruction").textContent = config.instruction;
    $("target").placeholder = config.placeholder;
    if (!$("target").value.trim()) {
      $("target").value = config.defaultText;
    }
  }

  // スライドバーの値表示更新
  $("n").addEventListener("input", (e) => {
    $("n-value").textContent = e.target.value + "回";
  });

  $("temp").addEventListener("input", (e) => {
    $("temp-value").textContent = parseFloat(e.target.value).toFixed(1);
  });

  // モードラジオボタンのイベント
  document.querySelectorAll('input[name="mode"]').forEach(radio => {
    radio.addEventListener("change", updateMode);
  });

  // 初期化
  updateMode();
  $("n-value").textContent = $("n").value + "回";
  $("temp-value").textContent = parseFloat($("temp").value).toFixed(1);

  // 統計計算
  function calcStats(texts) {
    const cleaned = texts.map(t => (t ?? "").trim());
    const set = new Set(cleaned);
    const lens = cleaned.map(t => charLenJP(t));
    const avgLen = lens.reduce((a,b)=>a+b,0) / Math.max(1, lens.length);

    const freq = new Map();
    for (const t of cleaned) freq.set(t, (freq.get(t) ?? 0) + 1);
    let modeCount = 0, modeText = "";
    for (const [t,c] of freq.entries()) if (c > modeCount) { modeCount = c; modeText = t; }

    return {
      n: cleaned.length,
      unique: set.size,
      uniqueRate: set.size/Math.max(1,cleaned.length),
      avgLen,
      modeCount,
      modeRate: modeCount/Math.max(1,cleaned.length),
      modeText
    };
  }

  // API呼び出し
  async function sampleMany({ prompt, n, mode, temperature }) {
    const url = `${WORKER_URL}/sample`;
    const res = await fetch(url, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ prompt, n, mode, temperature }),
    });
    if (!res.ok) throw new Error(await res.text());
    return await res.json();
  }

  // 出力表示
  function renderOutputs(list) {
    const root = $("outputs");
    root.innerHTML = "";
    list.forEach((t, i) => {
      const div = document.createElement("div");
      div.className = "output-item";
      div.textContent = `#${i+1}（${charLenJP(t)}字）\n${t}`;
      root.appendChild(div);
    });
  }

  // 実行ボタン
  $("run").addEventListener("click", async () => {
    const mode = document.querySelector('input[name="mode"]:checked').value;
    const target = $("target").value.trim();
    const n = parseInt($("n").value, 10);
    const temp = parseFloat($("temp").value);

    if (!target) {
      alert("目的語を入力してください");
      return;
    }

    const config = MODES[mode];

    // モードごとに適切なプロンプトを生成
    let prompt;
    if (mode === "summary") {
      prompt = `次の文章を20字で要約して：${target}`;
    } else if (mode === "yesno") {
      prompt = `次の質問にYesかNoで答えて：${target}`;
    } else if (mode === "association") {
      prompt = `${target}から連想する言葉を1つ答えて`;
    } else if (mode === "synonym") {
      prompt = `${target}の同義語を1つ答えて`;
    }

    $("run").disabled = true;
    $("status").textContent = "実行中...";
    $("summary").textContent = "";
    $("outputs").textContent = "";

    try {
      const { outputs } = await sampleMany({ prompt, n, mode, temperature: temp });
      renderOutputs(outputs);

      const s = calcStats(outputs);

      // ぶれの大きさを判定
      let varietyMsg = "";
      if (s.uniqueRate >= 0.9) varietyMsg = "非常に大きい（ほぼ全て違う）";
      else if (s.uniqueRate >= 0.7) varietyMsg = "大きい（多様な出力）";
      else if (s.uniqueRate >= 0.4) varietyMsg = "中程度（一部重複あり）";
      else if (s.uniqueRate > 0) varietyMsg = "小さい（同じ出力が多い）";
      else varietyMsg = "なし（全て同じ）";

      $("summary").textContent =
        `【試行回数】${s.n}回\n\n` +
        `【ぶれの大きさ】${varietyMsg}\n` +
        `  ユニーク数: ${s.unique}/${s.n}（${(s.uniqueRate*100).toFixed(1)}%）\n` +
        `  ※100%に近いほどぶれが大きい\n\n` +
        `【平均文字数】${s.avgLen.toFixed(1)}字\n\n` +
        `【最も多く出た答え】${s.modeCount}回（${(s.modeRate*100).toFixed(1)}%）\n` +
        `  「${s.modeText}」`;
      $("status").textContent = "完了";
    } catch (e) {
      $("status").textContent = "エラー";
      $("summary").textContent = String(e);
    } finally {
      setTimeout(() => { $("run").disabled = false; }, 800);
    }
  });
</script>
</body>
</html>
